<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Resume Builder — Clean Preview (A4-style)</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<!-- html2canvas + jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>/* ---------- GLOBAL & LAYOUT ---------- */
:root{
  --bg:#f4f6f8;
  --panel:#fff;
  --muted:#6b7280;
  --accent:#0f172a;
  --radius:10px;
  --gap:20px;
  font-family: 'Poppins', Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
  --resume-width:820px;  /* A4 width */
  --resume-height:1160px; /* A4 height */
  --panel-padding:16px;
}

*{box-sizing:border-box}
html,body{height:100%; margin:0; background:var(--bg); color:var(--accent); -webkit-font-smoothing:antialiased; padding:12px;}

/* WRAP */
.wrap{
  max-width:1600px;
  margin:0 auto;
  display:flex;
  gap:var(--gap);
  align-items:stretch;
  height:calc(100vh - 24px);
}

/* PANELS */
.panel, .preview-panel{
  flex:1 1 50%;
  background:var(--panel);
  border-radius:var(--radius);
  box-shadow:0 8px 24px rgba(12,18,28,0.06);
  padding:var(--panel-padding);
  overflow:auto;
  min-width:0;
}
/* .preview-panel{
  flex: 1 1 70%;
} */
/* ACCORDION */
.accordion{display:flex;flex-direction:column;gap:12px}
.section{border-radius:10px;border:1px solid rgba(15,23,42,0.05);background:#fff;overflow:hidden}
.section .head{font-size:14px;display:flex;justify-content:space-between;align-items:center;padding:0px 14px;cursor:pointer}
.chev{transition:transform .2s}
.section[aria-expanded="true"] .chev{transform:rotate(90deg)}
.panel-body{display:none;padding:12px 14px;border-top:1px solid rgba(15,23,42,0.03)}
.section[aria-expanded="true"] .panel-body{display:block}

/* FORM STYLES */
.form-row{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
label{min-width:120px;color:var(--muted);font-size:.86rem}
.input, textarea, select{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#fff;font-size:.95rem}
textarea{min-height:80px;resize:vertical}
.btn{background:#eef6ff;border-radius:8px;padding:8px 12px;border:1px solid rgba(12,18,28,0.04);cursor:pointer}
.btn.danger{background:#fff2f2;color:#b91c1c}
.item{border:1px dashed rgba(12,18,28,0.04);padding:10px;border-radius:8px;margin-bottom:10px}

/* ---------- PREVIEW / A4 RESUME ---------- */
.a4-wrapper { display:flex; justify-content:center; gap:12px; align-items:flex-start; padding:8px; }
.resume {
  width: 100%;
  height: 100%;
  background: #fff;
  border-radius: 0;
  box-shadow: none;
  padding: 24px;
  display: grid;
  grid-template-columns: 200px 2fr;
  gap: 24px;
  box-sizing: border-box;
  overflow: hidden;
}

/* LEFT COLUMN */
.r-left{border-right:1px solid rgba(0,0,0,0.06);padding-right:18px}
.r-avatar{display:flex;justify-content:center;margin-bottom:12px}
.r-avatar img{width:140px;height:140px;border-radius:50%;object-fit:cover}
.r-name h1{margin:0;font-weight:600;font-size:1.45rem; word-break:break-word}
.r-name .title{color:var(--muted);font-size:.95rem;margin-top:6px; word-break:break-word}
.r-contact{margin-top:16px;font-size:.95rem}
.r-contact li{list-style:none;margin:8px 0;display:flex;align-items:center; word-break:break-word}
.r-contact span.icon{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:6px;background:#0f172a;color:#fff;margin-right:10px;font-size:.85rem}
.r-left .section-block{margin-top:22px}
.r-left h4{margin:0 0 8px 0;font-size:.95rem}
.chip{display:inline-block;background:#f3f4f6;padding:6px 10px;border-radius:999px;margin:4px 6px 4px 0;font-size:.88rem;color:var(--muted)}

/* RIGHT COLUMN */
.r-right h2.section-title{margin:0 0 12px 0;font-size:1rem;border-bottom:1px solid rgba(12,18,28,0.06);padding-bottom:6px}
.summary{color:var(--muted);line-height:1.45;margin-bottom:12px}
.exp-item, .edu-item, .proj-item, .cert-item {margin-bottom:14px}
.exp-item h3, .edu-item h3, .proj-item h3{margin:0;font-size:1rem; word-break:break-word}
.muted{color:var(--muted)}
.meta{font-size:.88rem;color:var(--muted);margin-top:4px}
.desc{margin-top:6px;color:#0b1220;line-height:1.45;}

/* PDF PANEL */
.pdf-panel { border: 1px solid #ccc; padding: 12px; border-radius: 8px; background: #f9f9f9; max-width: 100%; margin-top:20px; font-family: 'Poppins', sans-serif; }
.pdf-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
.pdf-list { list-style:none; padding:0; margin:0 }
.pdf-list li{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; padding:6px 8px; border-bottom:1px solid #ddd; border-radius:4px; background:#fff }

/* MODAL */
.modal{ position: fixed; inset: 0; display: none; align-items:center; justify-content:center; background: rgba(2,6,23,0.45); z-index: 9999; }
.modal .box{ background:#fff; padding:18px; border-radius:10px; width:90%; max-width:920px; max-height:90vh; overflow:auto; }

/* PROFESSIONAL ONE-PAGE */
.resume{max-width:1200px;margin:auto; page-break-inside: avoid;}
.r-left, .r-right{overflow:hidden}
.r-right{padding-left:16px;}

/* RESPONSIVE */
@media (max-width:1199px) { .resume { transform: scale(0.85); } }
@media (max-width:1000px) { .resume { transform: scale(0.75); } }
@media (max-width:900px)  { .resume { transform: scale(0.65); } }
@media (max-width:767px){
  .wrap{flex-direction:column;height:auto}
  .preview-panel{display:none}
  .panel{flex:1 1 auto}
  .mobile-preview-btn{display:block}
}
</style>
</head>
<body>

<div class="wrap" role="application" aria-label="Resume builder">
  <!-- LEFT: existing accordion form -->
  <div class="panel" aria-hidden="false">
    <header style="margin-bottom:8px; display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2 style="margin:0">Resume Builder</h2>
        <div class="muted" style="font-size:0.9rem">Edit fields — preview updates live on right.</div>
      </div>
      <div>
        <!-- Mobile preview button (visible only on mobile) -->
        <button class="btn mobile-preview-btn" id="mobilePreviewBtn" style="display:none">Preview Resume</button>
      </div>
    </header>

    <div class="accordion" id="accordion">
      <!-- Personal -->
      <section class="section" data-key="personal" aria-expanded="true">
        <div class="head" tabindex="0"><h3><i class="fa-solid fa-user"></i> Personal Information</h3><i class="fa-solid fa-chevron-right chev"></i></div>
        <div class="panel-body">
          <div class="form-row"><label>Full Name</label><input id="fullName" class="input" placeholder="Ali Reza Narejo"></div>
          <div class="form-row"><label>Father Name</label><input id="fatherName" class="input" placeholder="Father Name"></div>
          <div class="form-row"><label>CNIC</label><input id="cnic" class="input" placeholder="XXXXX-XXXXXXX-X"></div>
          <div class="form-row"><label>Professional Title</label><input id="title" class="input" placeholder="Frontend Developer"></div>
          <div class="form-row"><label>Email</label><input id="email" class="input" placeholder="name@example.com"><label>Phone</label><input id="phone" class="input" placeholder="+92 300 0000000"></div>
          <div class="form-row"><label>Location</label><input id="location" class="input" placeholder="City, Country"><label>DOB</label><input id="dob" class="input" placeholder="DD/MM/YYYY"></div>
          <div class="form-row"><label>Profile Photo</label><input id="profilePhoto" type="file" accept="image/*"></div>
        </div>
      </section>

      <!-- Summary -->
      <section class="section" data-key="summary" aria-expanded="false">
        <div class="head" tabindex="0"><h3><i class="fa-solid fa-file-lines"></i> Professional Summary</h3><i class="fa-solid fa-chevron-right chev"></i></div>
        <div class="panel-body"><div class="form-row"><label>Summary</label><textarea id="summaryText" class="input" placeholder="Three to four lines summarizing your experience."></textarea></div></div>
      </section>

      <!-- Education -->
      <section class="section" data-key="education" aria-expanded="false">
        <div class="head" tabindex="0"><h3><i class="fa-solid fa-graduation-cap"></i> Education</h3><i class="fa-solid fa-chevron-right chev"></i></div>
        <div class="panel-body"><div id="education-list"></div><div style="margin-top:8px"><button id="add-education" class="btn">Add Education</button></div></div>
      </section>

      <!-- Experience -->
      <section class="section" data-key="experience" aria-expanded="false">
        <div class="head" tabindex="0"><h3><i class="fa-solid fa-briefcase"></i> Work Experience</h3><i class="fa-solid fa-chevron-right chev"></i></div>
        <div class="panel-body"><div id="experience-list"></div><div style="margin-top:8px"><button id="add-experience" class="btn">Add Role</button></div></div>
      </section>

      <!-- Skills -->
      <section class="section" data-key="skills" aria-expanded="false">
        <div class="head" tabindex="0"><h3><i class="fa-solid fa-lightbulb"></i> Skills</h3><i class="fa-solid fa-chevron-right chev"></i></div>
        <div class="panel-body"><div id="skills-list"></div><div style="margin-top:8px"><button id="add-skill" class="btn">Add Skill</button></div></div>
      </section>

      <!-- Projects / Custom -->
      <section class="section" data-key="custom" aria-expanded="false">
        <div class="head" tabindex="0"><h3><i class="fa-solid fa-layer-group"></i> Projects / Custom</h3><i class="fa-solid fa-chevron-right chev"></i></div>
        <div class="panel-body"><div id="custom-list"></div><div style="margin-top:8px"><button id="add-custom" class="btn">Add Section</button></div></div>
      </section>

      <!-- Certificates -->
      <section class="section" data-key="certificates" aria-expanded="false">
        <div class="head" tabindex="0"><h3><i class="fa-solid fa-certificate"></i> Certificates</h3><i class="fa-solid fa-chevron-right chev"></i></div>
        <div class="panel-body"><div id="certificates-list"></div><div style="margin-top:8px"><button id="add-certificate" class="btn">Add Certificate</button></div></div>
      </section>

      <!-- Languages -->
      <section class="section" data-key="languages" aria-expanded="false">
        <div class="head" tabindex="0"><h3><i class="fa-solid fa-language"></i> Languages</h3><i class="fa-solid fa-chevron-right chev"></i></div>
        <div class="panel-body"><div id="languages-list"></div><div style="margin-top:8px"><button id="add-language" class="btn">Add Language</button></div></div>
      </section>

      <!-- Hobbies -->
      <section class="section" data-key="hobbies" aria-expanded="false">
        <div class="head" tabindex="0"><h3><i class="fa-solid fa-heart"></i> Hobbies & Interests</h3><i class="fa-solid fa-chevron-right chev"></i></div>
        <div class="panel-body"><div id="hobbies-list"></div><div style="margin-top:8px"><button id="add-hobby" class="btn">Add Interest</button></div></div>
      </section>

      <!-- Save PDF -->
      <section class="section" data-key="pdf" aria-expanded="false">
        <div class="head" tabindex="0"><h3><i class="fa-solid fa-file-pdf"></i> PDF / Save</h3><i class="fa-solid fa-chevron-right chev"></i></div>
        <div class="panel-body">
          <div class="form-row"><label>CNIC for save</label><input id="saveCnic" class="input" placeholder="Enter CNIC (required to save)"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="savePdfBtn" class="btn">Save PDF to Storage</button>
            <button id="downloadPdfBtn" class="btn">Download PDF (local)</button>
          </div>
          <div style="margin-top:10px" id="saveStatus" class="muted"></div>
        </div>
      </section>

    </div>

    <!-- PDF Panel (left side under form) -->
    <div class="pdf-panel" id="pdfPanel">
      <div class="pdf-header">
        <strong>Saved PDFs</strong>
        <button id="refreshPdfPanel" class="btn">Refresh</button>
      </div>
      <ul class="pdf-list" id="pdfList">
        <li class="muted">No saved PDFs yet for current CNIC.</li>
      </ul>
    </div>

  </div>

  <!-- RIGHT: Preview (Clean White Theme, everything displayed on right column) -->
  <div class="preview-panel">
    <div class="preview-toolbar">
      <div style="flex:1"></div>
      <div><button id="downloadPreviewPdf" class="btn">Download</button></div>
    </div>
    <div class="a4-wrapper">
      <div class="resume" id="preview-resume">
        <!-- LEFT (very small): avatar + top info -->
        <div class="r-left">
          <div class="r-avatar" id="pv-avatar"><img src="https://i.pinimg.com/564x/eb/57/6f/eb576ff023487bcb1fa3ad61ee7b23ee.jpg" alt="avatar"></div>
          <div class="r-name" style="margin-top:12px">
            <h1 id="pv-name">Your Name</h1>
            <div class="title" id="pv-title">Professional Title</div>
          </div>

          <div class="r-contact">
            <ul style="padding:0;margin-top:12px;">
              <li><span class="icon">P</span><span id="pv-phone">+92 300 0000000</span></li>
              <li><span class="icon">E</span><span id="pv-email">email@example.com</span></li>
              <li><span class="icon">L</span><span id="pv-location">City, Country</span></li>
              <li><span class="icon">I</span><span id="pv-cnic">CNIC</span></li>
            </ul>
          </div>

          <!-- Small left blocks -->
          <div class="section-block" id="pv-left-skills"><h4>Skills</h4><div id="pv-left-skills-list"></div></div>
          <div class="section-block" id="pv-left-langs"><h4>Languages</h4><div id="pv-left-langs-list"></div></div>
          <div class="section-block" id="pv-left-certs"><h4>Certificates</h4><div id="pv-left-certs-list"></div></div>
          <div class="section-block" id="pv-left-hobbies"><h4>Hobbies</h4><div id="pv-left-hobbies-list"></div></div>
        </div>

        <!-- RIGHT (main content): summary, experience, education, projects, etc -->
        <div class="r-right">
          <h2 class="section-title">Profile</h2>
          <div class="summary" id="pv-summary">A concise career summary will appear here as you type.</div>

          <div id="pv-experience">
            <h2 class="section-title">Experience</h2>
            <!-- items injected -->
          </div>

          <div id="pv-education">
            <h2 class="section-title">Education</h2>
            <!-- items injected -->
          </div>

          <div id="pv-projects">
            <h2 class="section-title">Projects</h2>
            <!-- items injected -->
          </div>

          <div id="pv-certificates-right">
            <h2 class="section-title">Certificates</h2>
            <!-- items injected -->
          </div>

          <div id="pv-languages-right">
            <h2 class="section-title">Languages</h2>
            <!-- items injected -->
          </div>

          <div id="pv-hobbies-right">
            <h2 class="section-title">Hobbies & Interests</h2>
            <!-- items injected -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- Modal (generic) -->
<div class="modal" id="modal">
  <div class="box">
    <h3 id="modalTitle">Page full</h3>
    <p id="modalText">Your resume page area is full. Remove some content to add more.</p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="modalClose" class="btn">OK</button>
    </div>
  </div>
</div>

<!-- Preview modal for mobile -->
<div class="modal" id="previewModal">
  <div class="box" id="previewModalBox">
    <!-- cloned resume will be injected here on mobile preview -->
  </div>
</div>

<!-- PDF logic module (separate file) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script type="module" src="./pdf.js"></script>

<!-- Original Live preview + controls script (preserved exactly) -->
<script>
// (original script content preserved — unchanged)
document.addEventListener('DOMContentLoaded', () => {

  // ---------- Utilities ----------
  const q = s => document.querySelector(s);
  const qa = s => Array.from(document.querySelectorAll(s));
  const debounce = (fn, t = 120) => { let id; return (...a) => { clearTimeout(id); id = setTimeout(() => fn(...a), t); }; };

  // ---------- Limits ----------
  const MAX_ITEMS = 10;
  const MAX_SUMMARY_CHARS = 800;
  const MAX_DESC_CHARS = 800;

  // ---------- Small helpers ----------
  function clampInput(el, maxChars){
    if(!el) return;
    el.addEventListener('input', () => { if (el.value.length > maxChars) el.value = el.value.slice(0, maxChars); });
  }

  // ---------- Modal (safe guards if missing) ----------
  const modal = q('#modal');
  const modalClose = q('#modalClose');
  function showModal(title, text){
    if(!modal) { alert(title + '\n\n' + text); return; }
    const t = q('#modalTitle'), b = q('#modalText');
    if(t) t.textContent = title;
    if(b) b.textContent = text;
    modal.style.display = 'flex';
  }
  if(modalClose) modalClose.addEventListener('click', ()=> modal.style.display = 'none');

  // ---------- Escape helpers ----------
  function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
  function escapeSafe(s=''){ return String(s).replaceAll('<','').replaceAll('>',''); }

  // ---------- Preview overflow check ----------
  function previewWouldOverflow(){
    const resume = q('#preview-resume');
    if(!resume) return false;
    const clone = resume.cloneNode(true);
    clone.style.position = 'absolute';
    clone.style.left = '-9999px';
    clone.style.top = '-9999px';
    clone.style.width = resume.offsetWidth + 'px';
    clone.style.maxHeight = 'none';
    clone.style.overflow = 'visible';
    document.body.appendChild(clone);
    // We measure scrollHeight vs clientHeight (clientHeight of visible area we want to keep)
    const overflow = clone.scrollHeight > resume.clientHeight;
    document.body.removeChild(clone);
    return overflow;
  }

  // ---------- Debounced preview placeholder (defined early so other functions can reference it) ----------
  let debouncedPreview = (...a) => {}; // will be assigned after triggerPreview is declared

  // ---------- Attach helpers ----------
  function attachInputChange(node){
    if(!node) return;
    node.querySelectorAll('input,textarea,select').forEach(el => el.addEventListener('input', (...args) => debouncedPreview(...args)));
  }
  function attachRemove(node, selector){
    const btn = node.querySelector(selector);
    if(!btn) return;
    btn.addEventListener('click', () => {
      node.remove();
      updateAddButtons();
      triggerPreview(); // immediate update
    });
  }

  // ---------- Item factories (with clamp where required) ----------
  function makeEducationItem(data = {}){
    const w = document.createElement('div'); w.className = 'item education-item';
    w.innerHTML = `
      <div class="form-row"><label>Institution</label><input class="input inst" placeholder="University" value="${escapeHtml(data.institution||'')}"></div>
      <div class="form-row"><label>Degree / Field</label><input class="input degree" placeholder="BS Computer Science" value="${escapeHtml(data.degree||'')}"></div>
      <div class="form-row"><label>Start</label><input class="input small start-year" placeholder="2018" value="${escapeHtml(data.start||'')}"><label>Graduation</label><input class="input small grad-year" placeholder="2022" value="${escapeHtml(data.grad||'')}"></div>
      <div style="display:flex;justify-content:flex-end"><button class="btn danger remove-education">Remove</button></div>
    `;
    attachRemove(w, '.remove-education');
    attachInputChange(w);
    return w;
  }

  function makeExperienceItem(data = {}){
    const w = document.createElement('div'); w.className = 'item experience-item';
    w.innerHTML = `
      <div class="form-row"><label>Job Title</label><input class="input job-title" placeholder="Frontend Developer" value="${escapeHtml(data.jobTitle||'')}"></div>
      <div class="form-row"><label>Company</label><input class="input company" placeholder="Company name" value="${escapeHtml(data.company||'')}"></div>
      <div class="form-row"><label>Start</label><input class="input small start" placeholder="2019" value="${escapeHtml(data.start||'')}"><label>End</label><input class="input small end" placeholder="2021 or Present" value="${escapeHtml(data.end||'')}"></div>
      <div class="form-row"><label>Description</label><textarea class="input resp" placeholder="Responsibilities or achievements">${escapeHtml(data.resp||'')}</textarea></div>
      <div style="display:flex;justify-content:flex-end"><button class="btn danger remove-experience">Remove</button></div>
    `;
    attachRemove(w, '.remove-experience');
    attachInputChange(w);
    clampInput(w.querySelector('.resp'), MAX_DESC_CHARS);
    return w;
  }

  function makeSkillItem(data = {}){
    const w = document.createElement('div'); w.className = 'item skill-item';
    w.innerHTML = `
      <div class="form-row">
        <label>Skill</label><input class="input skill-name" placeholder="JavaScript" value="${escapeHtml(data.name||'')}">
        <label style="min-width:110px">Level</label>
        <select class="input small skill-level">
          <option value="">Select level</option>
          <option ${data.level==='Beginner'?'selected':''}>Beginner</option>
          <option ${data.level==='Intermediate'?'selected':''}>Intermediate</option>
          <option ${data.level==='Advanced'?'selected':''}>Advanced</option>
          <option ${data.level==='Expert'?'selected':''}>Expert</option>
        </select>
      </div>
      <div style="display:flex;justify-content:flex-end"><button class="btn danger remove-skill">Remove</button></div>
    `;
    attachRemove(w, '.remove-skill');
    attachInputChange(w);
    return w;
  }

  function makeCustomItem(data = {}){
    const w = document.createElement('div'); w.className = 'item custom-item';
    w.innerHTML = `
      <div class="form-row"><label>Title</label><input class="input custom-title" placeholder="Project Title" value="${escapeHtml(data.title||'')}"></div>
      <div class="form-row"><label>Content</label><textarea class="input custom-content" placeholder="Description...">${escapeHtml(data.content||'')}</textarea></div>
      <div style="display:flex;justify-content:flex-end"><button class="btn danger remove-custom">Remove</button></div>
    `;
    attachRemove(w, '.remove-custom');
    attachInputChange(w);
    clampInput(w.querySelector('.custom-content'), MAX_DESC_CHARS);
    return w;
  }

  function makeCertificateItem(data = {}){
    const w = document.createElement('div'); w.className = 'item certificate-item';
    w.innerHTML = `
      <div class="form-row"><label>Certificate</label><input class="input cert-name" placeholder="Certificate Title" value="${escapeHtml(data.name||'')}"></div>
      <div class="form-row"><label>Issuer</label><input class="input cert-by" placeholder="Issuer" value="${escapeHtml(data.by||'')}"><label>Year</label><input class="input small cert-year" placeholder="2024" value="${escapeHtml(data.year||'')}"></div>
      <div style="display:flex;justify-content:flex-end"><button class="btn danger remove-certificate">Remove</button></div>
    `;
    attachRemove(w, '.remove-certificate');
    attachInputChange(w);
    return w;
  }

  function makeLanguageItem(data = {}){
    const w = document.createElement('div'); w.className = 'item language-item';
    w.innerHTML = `
      <div class="form-row">
        <label>Language</label><input class="input lang-name" placeholder="Urdu" value="${escapeHtml(data.lang||'')}">
        <label style="min-width:110px">Fluency</label>
        <select class="input small lang-level">
          <option value="">Select level</option>
          <option ${data.level==='Beginner'?'selected':''}>Beginner</option>
          <option ${data.level==='Intermediate'?'selected':''}>Intermediate</option>
          <option ${data.level==='Fluent'?'selected':''}>Fluent</option>
          <option ${data.level==='Native'?'selected':''}>Native</option>
        </select>
      </div>
      <div style="display:flex;justify-content:flex-end"><button class="btn danger remove-language">Remove</button></div>
    `;
    attachRemove(w, '.remove-language');
    attachInputChange(w);
    return w;
  }

  function makeHobbyItem(data = {}){
    const w = document.createElement('div'); w.className = 'item hobby-item';
    w.innerHTML = `
      <div class="form-row"><label>Hobby</label><input class="input hobby-name" placeholder="Photography" value="${escapeHtml(data.hobby||'')}"></div>
      <div style="display:flex;justify-content:flex-end"><button class="btn danger remove-hobby">Remove</button></div>
    `;
    attachRemove(w, '.remove-hobby');
    attachInputChange(w);
    return w;
  }

  // ---------- Containers & buttons ----------
  const educationList = q('#education-list'), experienceList = q('#experience-list'),
        skillsList = q('#skills-list'), customList = q('#custom-list'),
        certificatesList = q('#certificates-list'), languagesList = q('#languages-list'),
        hobbiesList = q('#hobbies-list');

  const addButtons = {
    education: q('#add-education'),
    experience: q('#add-experience'),
    skill: q('#add-skill'),
    custom: q('#add-custom'),
    cert: q('#add-certificate'),
    language: q('#add-language'),
    hobby: q('#add-hobby')
  };

  // ---------- Safe append with overflow + limit checks ----------
  function safeAppend(listEl, nodeFactory, addBtnKey){
    const btn = addButtons[addBtnKey];
    if(!btn || !listEl) return;
    btn.addEventListener('click', () => {
      if (listEl.querySelectorAll('.item').length >= MAX_ITEMS){
        showModal('Limit reached', 'You have reached the maximum items for this section.');
        updateAddButtons();
        return;
      }
      const newNode = nodeFactory();
      listEl.appendChild(newNode);
      // immediate attach done inside factory
      triggerPreview(); // update preview content
      if (previewWouldOverflow()){
        newNode.remove();
        triggerPreview();
        showModal('Page area is full', 'Your resume page area is full. Remove some content to add more.');
        return;
      }
      updateAddButtons();
      triggerPreview();
    });
  }

  safeAppend(educationList, makeEducationItem, 'education');
  safeAppend(experienceList, makeExperienceItem, 'experience');
  safeAppend(skillsList, makeSkillItem, 'skill');
  safeAppend(customList, makeCustomItem, 'custom');
  safeAppend(certificatesList, makeCertificateItem, 'cert');
  safeAppend(languagesList, makeLanguageItem, 'language');
  safeAppend(hobbiesList, makeHobbyItem, 'hobby');

  // ---------- Initial population ----------
  function initialPopulate(){
    if(educationList && educationList.children.length === 0) educationList.appendChild(makeEducationItem());
    if(experienceList && experienceList.children.length === 0) experienceList.appendChild(makeExperienceItem());
    if(skillsList && skillsList.children.length === 0) skillsList.appendChild(makeSkillItem());
    if(customList && customList.children.length === 0) customList.appendChild(makeCustomItem());
    if(certificatesList && certificatesList.children.length === 0) certificatesList.appendChild(makeCertificateItem());
    if(languagesList && languagesList.children.length === 0) languagesList.appendChild(makeLanguageItem());
    if(hobbiesList && hobbiesList.children.length === 0) hobbiesList.appendChild(makeHobbyItem());
    updateAddButtons();
  }
  initialPopulate();

  // ---------- Update add-buttons state ----------
  function updateAddButtons(){
    Object.entries(addButtons).forEach(([key, btn]) => {
      if(!btn) return;
      let list;
      switch(key){
        case 'education': list = educationList; break;
        case 'experience': list = experienceList; break;
        case 'skill': list = skillsList; break;
        case 'custom': list = customList; break;
        case 'cert': list = certificatesList; break;
        case 'language': list = languagesList; break;
        case 'hobby': list = hobbiesList; break;
      }
      btn.disabled = !list || list.querySelectorAll('.item').length >= MAX_ITEMS;
    });
  }

  // ---------- Wire top-level inputs ----------
  ['#fullName','#fatherName','#title','#email','#phone','#location','#dob','#summaryText','#cnic','#saveCnic'].forEach(sel => {
    const el = q(sel);
    if(el) el.addEventListener('input', () => debouncedPreview());
  });
  clampInput(q('#summaryText'), MAX_SUMMARY_CHARS);

  // ---------- Profile photo handling ----------
  const profilePhotoEl = q('#profilePhoto');
  if(profilePhotoEl) profilePhotoEl.addEventListener('change', (e) => {
    const f = e.target.files?.[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    const img = q('#pv-avatar img');
    if(img){ img.src = url; } else { q('#pv-avatar').innerHTML = `<img src="${url}" alt="avatar">`; }
  });

  // ---------- Collect data ----------
  function collectData(){
    const personal = {
      name: q('#fullName')?.value.trim() || '',
      father: q('#fatherName')?.value.trim() || '',
      cnic: q('#cnic')?.value.trim() || '',
      title: q('#title')?.value.trim() || '',
      email: q('#email')?.value.trim() || '',
      phone: q('#phone')?.value.trim() || '',
      location: q('#location')?.value.trim() || '',
      dob: q('#dob')?.value.trim() || '',
      summary: q('#summaryText')?.value.trim() || ''
    };

    const education = (educationList ? Array.from(educationList.querySelectorAll('.education-item')) : []).map(item => ({
      institution: item.querySelector('.inst')?.value.trim() || '',
      degree: item.querySelector('.degree')?.value.trim() || '',
      start: item.querySelector('.start-year')?.value.trim() || '',
      grad: item.querySelector('.grad-year')?.value.trim() || ''
    })).filter(x => x.institution || x.degree);

    const experience = (experienceList ? Array.from(experienceList.querySelectorAll('.experience-item')) : []).map(item => ({
      jobTitle: item.querySelector('.job-title')?.value.trim() || '',
      company: item.querySelector('.company')?.value.trim() || '',
      start: item.querySelector('.start')?.value.trim() || '',
      end: item.querySelector('.end')?.value.trim() || '',
      resp: item.querySelector('.resp')?.value.trim() || ''
    })).filter(x => x.jobTitle || x.company);

    const skills = (skillsList ? Array.from(skillsList.querySelectorAll('.skill-item')) : []).map(item => ({
      name: item.querySelector('.skill-name')?.value.trim() || '',
      level: item.querySelector('.skill-level')?.value.trim() || ''
    })).filter(x => x.name);

    const custom = (customList ? Array.from(customList.querySelectorAll('.custom-item')) : []).map(item => ({
      title: item.querySelector('.custom-title')?.value.trim() || '',
      content: item.querySelector('.custom-content')?.value.trim() || ''
    })).filter(x => x.title || x.content);

    const certificates = (certificatesList ? Array.from(certificatesList.querySelectorAll('.certificate-item')) : []).map(item => ({
      name: item.querySelector('.cert-name')?.value.trim() || '',
      by: item.querySelector('.cert-by')?.value.trim() || '',
      year: item.querySelector('.cert-year')?.value.trim() || ''
    })).filter(x => x.name);

    const languages = (languagesList ? Array.from(languagesList.querySelectorAll('.language-item')) : []).map(item => ({
      lang: item.querySelector('.lang-name')?.value.trim() || '',
      level: item.querySelector('.lang-level')?.value.trim() || ''
    })).filter(x => x.lang);

    const hobbies = (hobbiesList ? Array.from(hobbiesList.querySelectorAll('.hobby-item')) : []).map(item => ({
      hobby: item.querySelector('.hobby-name')?.value.trim() || ''
    })).filter(x => x.hobby);

    return { personal, education, experience, skills, custom, certificates, languages, hobbies };
  }

  // ---------- Render preview ----------
  function renderPreview(data){
    if(!data) return;
    const setText = (sel, v) => { const el = q(sel); if(el) el.textContent = v || ''; };

    setText('#pv-name', data.personal.name || 'Your Name');
    setText('#pv-title', data.personal.title || 'Professional Title');
    setText('#pv-email', data.personal.email || '');
    setText('#pv-phone', data.personal.phone || '');
    setText('#pv-location', data.personal.location || '');
    setText('#pv-cnic', data.personal.cnic || '');

    // left lists
    const leftSkills = q('#pv-left-skills-list'); if(leftSkills) { leftSkills.innerHTML = ''; if(data.skills.length) data.skills.forEach(s => { const c = document.createElement('div'); c.className='chip'; c.textContent = s.name + (s.level? ' — '+s.level : ''); leftSkills.appendChild(c); }); else leftSkills.innerHTML = '<div class="muted">No skills</div>'; }
    const leftLangs = q('#pv-left-langs-list'); if(leftLangs) { leftLangs.innerHTML=''; if(data.languages.length) data.languages.forEach(l => { const c = document.createElement('div'); c.className='chip'; c.textContent = l.lang + (l.level? ' — '+l.level : ''); leftLangs.appendChild(c); }); else leftLangs.innerHTML = '<div class="muted">No languages</div>'; }
    const leftCerts = q('#pv-left-certs-list'); if(leftCerts) { leftCerts.innerHTML=''; if(data.certificates.length) data.certificates.forEach(c => { const d = document.createElement('div'); d.className='chip'; d.textContent = c.name; leftCerts.appendChild(d); }); else leftCerts.innerHTML = '<div class="muted">No certificates</div>'; }
    const leftHobbies = q('#pv-left-hobbies-list'); if(leftHobbies) { leftHobbies.innerHTML=''; if(data.hobbies.length) data.hobbies.forEach(h => { const d = document.createElement('div'); d.className='chip'; d.textContent = h.hobby; leftHobbies.appendChild(d); }); else leftHobbies.innerHTML = '<div class="muted">No hobbies</div>'; }

    setText('#pv-summary', data.personal.summary || 'A concise career summary will appear here as you type.');

    // Experience
    const expContainer = q('#pv-experience'); if(expContainer){ expContainer.innerHTML = '<h2 class="section-title">Experience</h2>'; if(data.experience.length){ data.experience.forEach(exp => { const d = document.createElement('div'); d.className='exp-item'; const h = document.createElement('h3'); h.textContent = exp.jobTitle || ''; const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${exp.start || ''} — ${exp.end || ''} • ${exp.company || ''}`; const desc = document.createElement('div'); desc.className='desc'; if(exp.resp && exp.resp.includes('\n')){ const ul = document.createElement('ul'); exp.resp.split('\n').filter(Boolean).forEach(line => { const li = document.createElement('li'); li.textContent = line; ul.appendChild(li); }); desc.appendChild(ul); } else { desc.textContent = exp.resp || ''; } d.appendChild(h); d.appendChild(meta); d.appendChild(desc); expContainer.appendChild(d); }); } else { expContainer.innerHTML += '<div class="muted">No experience added</div>'; } }

    // Education
    const eduContainer = q('#pv-education'); if(eduContainer){ eduContainer.innerHTML = '<h2 class="section-title">Education</h2>'; if(data.education.length){ data.education.forEach(e => { const d = document.createElement('div'); d.className='edu-item'; const h = document.createElement('h3'); h.textContent = e.degree || e.institution; const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${e.start || ''} — ${e.grad || ''} • ${e.institution || ''}`; d.appendChild(h); d.appendChild(meta); eduContainer.appendChild(d); }); } else { eduContainer.innerHTML += '<div class="muted">No education added</div>'; } }

    // Projects / Custom
    const prContainer = q('#pv-projects'); if(prContainer){ prContainer.innerHTML = '<h2 class="section-title">Projects</h2>'; if(data.custom.length){ data.custom.forEach(p => { const d = document.createElement('div'); d.className='proj-item'; const h = document.createElement('h3'); h.textContent = p.title || ''; const desc = document.createElement('div'); desc.className='desc'; if(p.content && p.content.includes('\n')){ const ul = document.createElement('ul'); p.content.split('\n').filter(Boolean).forEach(line => { const li = document.createElement('li'); li.textContent = line; ul.appendChild(li); }); desc.appendChild(ul); } else { desc.textContent = p.content || ''; } d.appendChild(h); d.appendChild(desc); prContainer.appendChild(d); }); } else prContainer.innerHTML += '<div class="muted">No projects added</div>'; }

    // Certificates, Languages, Hobbies (right)
    const certR = q('#pv-certificates-right'); if(certR){ certR.innerHTML = '<h2 class="section-title">Certificates</h2>'; if(data.certificates.length){ data.certificates.forEach(c => { const d = document.createElement('div'); d.className='cert-item'; const h = document.createElement('h3'); h.textContent = c.name + (c.by ? ' — '+c.by : ''); const meta = document.createElement('div'); meta.className='meta'; meta.textContent = c.year || ''; d.appendChild(h); d.appendChild(meta); certR.appendChild(d); }); } else certR.innerHTML += '<div class="muted">No certificates added</div>'; }

    const langR = q('#pv-languages-right'); if(langR){ langR.innerHTML = '<h2 class="section-title">Languages</h2>'; if(data.languages.length){ const ul = document.createElement('ul'); ul.className='clean'; data.languages.forEach(l => { const li = document.createElement('li'); li.textContent = `${l.lang}${l.level ? ' — '+l.level : ''}`; ul.appendChild(li); }); langR.appendChild(ul); } else langR.innerHTML += '<div class="muted">No languages added</div>'; }

    const hbR = q('#pv-hobbies-right'); if(hbR){ hbR.innerHTML = '<h2 class="section-title">Hobbies & Interests</h2>'; if(data.hobbies.length){ const div = document.createElement('div'); div.className='skill-grid'; data.hobbies.forEach(h => { const chip = document.createElement('div'); chip.className='chip'; chip.textContent = h.hobby; div.appendChild(chip); }); hbR.appendChild(div); } else hbR.innerHTML += '<div class="muted">No hobbies added</div>'; }
  }

  // ---------- Trigger preview (and persist) ----------
  function triggerPreview(){
    const d = collectData();
    renderPreview(d);
    try { localStorage.setItem('resumeDraft', JSON.stringify(d)); } catch(e) {}
    updateAddButtons();
  }

  // now safe assign debouncedPreview
  debouncedPreview = debounce(triggerPreview, 90);

  // ---------- Load draft ----------
  (function loadDraft(){
    try {
      const raw = localStorage.getItem('resumeDraft'); if(!raw) return;
      const d = JSON.parse(raw);
      if(d.personal){
        if(q('#fullName')) q('#fullName').value = d.personal.name || '';
        if(q('#fatherName')) q('#fatherName').value = d.personal.father || '';
        if(q('#cnic')) q('#cnic').value = d.personal.cnic || '';
        if(q('#title')) q('#title').value = d.personal.title || '';
        if(q('#email')) q('#email').value = d.personal.email || '';
        if(q('#phone')) q('#phone').value = d.personal.phone || '';
        if(q('#location')) q('#location').value = d.personal.location || '';
        if(q('#dob')) q('#dob').value = d.personal.dob || '';
        if(q('#summaryText')) q('#summaryText').value = d.personal.summary || '';
      }
      // clear lists then populate
      if(educationList) educationList.innerHTML = '';
      if(experienceList) experienceList.innerHTML = '';
      if(skillsList) skillsList.innerHTML = '';
      if(customList) customList.innerHTML = '';
      if(certificatesList) certificatesList.innerHTML = '';
      if(languagesList) languagesList.innerHTML = '';
      if(hobbiesList) hobbiesList.innerHTML = '';

      (d.education||[]).forEach(e => educationList && educationList.appendChild(makeEducationItem(e)));
      (d.experience||[]).forEach(e => experienceList && experienceList.appendChild(makeExperienceItem(e)));
      (d.skills||[]).forEach(s => skillsList && skillsList.appendChild(makeSkillItem(s)));
      (d.custom||[]).forEach(c => customList && customList.appendChild(makeCustomItem(c)));
      (d.certificates||[]).forEach(c => certificatesList && certificatesList.appendChild(makeCertificateItem(c)));
      (d.languages||[]).forEach(l => languagesList && languagesList.appendChild(makeLanguageItem(l)));
      (d.hobbies||[]).forEach(h => hobbiesList && hobbiesList.appendChild(makeHobbyItem(h)));
    } catch(e) {}
    triggerPreview();
  })();

  // ---------- Accordion single-open behaviour ----------
  (function initAccordion(){
    qa('.section').forEach(section => {
      const head = section.querySelector('.head');
      if(!head) return;
      head.addEventListener('click', () => toggle(section));
      head.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(section); }});
    });
    function toggle(section){
      qa('.section').forEach(s => { if(s !== section) s.setAttribute('aria-expanded', 'false'); });
      const expanded = section.getAttribute('aria-expanded') === 'true';
      section.setAttribute('aria-expanded', expanded ? 'false' : 'true');
    }
  })();

  // ---------- Initial render ----------
  triggerPreview();

  // ---------- Expose helpers for pdf.js ----------
  window._resume_getPreviewElement = () => document.getElementById('preview-resume');
  window._resume_collectData = collectData;
  window._resume_triggerPreview = triggerPreview;
  window._resume_previewWouldOverflow = previewWouldOverflow;
  window._resume_getSaveCnic = () => q('#saveCnic')?.value?.trim() || '';
  window._resume_setSaveStatus = (text) => { const el = q('#saveStatus'); if(el) el.textContent = text; };

});
</script>

<!-- NEW: small UI helpers for responsive preview & mobile button (non-destructive) -->
<script>
(function(){
  // show/hide mobile preview button based on width
  const mobilePreviewBtn = document.getElementById('mobilePreviewBtn');
  const previewModal = document.getElementById('previewModal');
  const previewModalBox = document.getElementById('previewModalBox');
  const previewPanel = document.querySelector('.preview-panel');
  function updateMobileUI(){
    if(window.innerWidth <= 767){
      if(mobilePreviewBtn) mobilePreviewBtn.style.display = 'inline-block';
    } else {
      if(mobilePreviewBtn) mobilePreviewBtn.style.display = 'none';
    }
  }
  window.addEventListener('resize', updateMobileUI);
  document.addEventListener('DOMContentLoaded', updateMobileUI);

  // open preview modal on mobile: clone resume for safe display
  if(mobilePreviewBtn){
    mobilePreviewBtn.addEventListener('click', () => {
      if(!previewModal || !previewModalBox) return;
      const resume = document.getElementById('preview-resume');
      if(!resume) return;
      // clone & make scrollable inside modal
      const clone = resume.cloneNode(true);
      clone.style.transform = 'scale(0.9)';
      clone.style.transformOrigin = 'top center';
      clone.style.width = 'calc(var(--resume-width) * 0.9)';
      clone.style.height = 'calc(var(--resume-height) * 0.9)';
      clone.style.margin = '0 auto';
      clone.style.boxShadow = '0 12px 40px rgba(2,6,23,0.3)';
      previewModalBox.innerHTML = '';
      previewModalBox.appendChild(clone);
      previewModal.style.display = 'flex';
    });
  }
  // close modal when clicking outside box or pressing Esc
  document.addEventListener('click', (e) => {
    if(!previewModal) return;
    if(e.target === previewModal) previewModal.style.display = 'none';
  });
  document.addEventListener('keydown', (e) => { if(e.key === 'Escape'){ if(previewModal) previewModal.style.display = 'none'; } });

  // hook download button in preview toolbar to trigger existing download action if present
  const downloadPreviewPdf = document.getElementById('downloadPreviewPdf');
  if(downloadPreviewPdf){
    downloadPreviewPdf.addEventListener('click', () => {
      const dlBtn = document.getElementById('downloadPdfBtn');
      if(dlBtn) dlBtn.click();
    });
  }
})();


</script>

</body>
</html>
