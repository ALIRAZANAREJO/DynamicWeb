<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Select Skills (UI Enhanced)</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --muted:#97a0b5; --accent:#00337f;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, system-ui, Arial; margin:24px; background:var(--bg); color:#102132}
  h2{margin:0 0 12px;font-size:20px}
  /* Search */
  .search-wrap{max-width:820px;margin:0 auto}
  #searchInput{
    width:100%; padding:14px 16px; font-size:16px; border-radius:10px; border:1px solid #d6dbe6;
    background:linear-gradient(180deg,#fff,#fbfdff);
    outline:none; transition:box-shadow .15s, border-color .15s;
  }
  #searchInput:focus{box-shadow:0 6px 18px rgba(3,51,127,0.08); border-color:#b6c6ea}
  .hint{font-size:13px;color:var(--muted);margin-top:6px}
  /* Dropdown / cards */
  .panel{margin-top:12px; display:none; background:transparent}
  .cards{display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:10px}
  .card{
    background:var(--card); border-radius:10px; padding:10px; display:flex; align-items:center; gap:10px; cursor:pointer;
    border:1px solid rgba(16,33,50,0.04); transition:transform .12s, box-shadow .12s, border-color .12s;
    position:relative; min-height:56px;
  }
  .card:hover{transform:translateY(-4px); box-shadow:0 10px 20px rgba(16,33,50,0.06)}
  .card.highlight{border-color:#cfe0ff; box-shadow:0 8px 18px rgba(3,51,127,0.06)}
  .icon{
    width:46px;height:46px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:18px;
    box-shadow:0 2px 8px rgba(16,33,50,0.06)
  }
  .meta{flex:1}
  .skill-name{font-weight:600; font-size:15px; color:#0f2b44}
  .small{font-size:12px; color:var(--muted); margin-top:3px}
  /* percent badge */
  .percent-badge{
    position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.06); padding:4px 8px; border-radius:999px; font-weight:600; font-size:12px;
    display:flex;align-items:center;gap:6px; color:#0f2b44;
  }
  .percent-badge .pencil{font-size:12px; cursor:pointer; opacity:.9}
  .percent-edit{width:56px;padding:4px 6px;border-radius:6px;border:1px solid #d6dbe6;font-weight:600}
  /* selected tags */
  #selectedContainer{margin-top:18px; display:flex; flex-wrap:wrap; gap:10px; max-width:820px}
  .skill-tag{background:#00337f;color:white;padding:6px 10px;border-radius:14px;display:flex;align-items:center;gap:8px}
  .skill-tag input{width:48px;padding:4px;border-radius:6px;border:none;font-size:13px}
  .remove-btn{cursor:pointer;font-weight:700}
  /* colors for icons */
  .ic-html{background:#e44d26} .ic-css{background:#0b6ebf} .ic-js{background:#f1c40f;color:#111}
  .ic-py{background:#3572A5} .ic-node{background:#3c873a} .ic-react{background:#61dafb;color:#021124}
  .ic-sql{background:#6f42c1} .ic-java{background:#d14b3f} .ic-cpp{background:#00599c}
  /* small helpers */
  .hidden{display:none!important}
  @media (max-width:520px){ .cards{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>

<div class="search-wrap">
  <h2>Select Skills</h2>
  <input id="searchInput" type="text" placeholder="" aria-label="Search skills" autocomplete="off" />
  <div class="hint">Click on input to open skill picker ‚Ä¢ Use ‚Üë ‚Üì ‚Üê ‚Üí keys and Enter to choose</div>

  <div id="panel" class="panel" aria-hidden="true">
    <div style="margin-top:8px" id="cards" class="cards"></div>
  </div>
</div>

<div id="selectedContainer"></div>

<button id="submitBtn" style="margin-top:16px;padding:10px 18px;font-size:16px;cursor:pointer">Save Skills & Go Back</button>
<!-- ===== STEP 2 (Standalone) : Fields ‚Üí Subcategories ‚Üí Skills with Left Selected Panel ===== -->
<style>
/* Step-2 styles (standalone) */
#fieldsSystem { display:flex; gap:16px; margin-top:36px; align-items:flex-start; }

/* left selected panel */
#selectedPanel {
  width:260px;
  min-width:200px;
  background:#fbfbff;
  border:1px solid #e6e9f2;
  border-radius:10px;
  padding:12px;
  box-shadow:0 6px 18px rgba(3,51,127,0.04);
  position:sticky;
  top:20px;
  height:calc(100vh - 40px);
  overflow:auto;
}
#selectedPanel h3{margin:0 0 8px;font-size:15px}
.selected-list{display:flex;flex-direction:column;gap:8px}
.sel-item{display:flex;align-items:center;gap:8px;background:#00337f;color:#fff;padding:6px 8px;border-radius:8px}
.sel-item .icon{width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700}
.sel-item .name{flex:1;font-weight:600}
.sel-item .pct{margin-left:6px;font-weight:700}
.sel-item .remove{cursor:pointer;margin-left:8px;font-weight:800}

/* main area */
#fieldsMain { flex:1; }

/* field row */
.field-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
.field-card{
  flex:0 0 220px;
  min-width:160px;
  background:#fff;padding:12px;border-radius:10px;border:1px solid #e6e9f2;cursor:pointer;
  display:flex;align-items:center;gap:10px;box-shadow:0 6px 18px rgba(3,51,127,0.02);
}
.field-card.active{border-color:#cfe0ff; box-shadow:0 10px 24px rgba(3,51,127,0.06)}
.field-card .icon{width:46px;height:46px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.field-title{font-weight:700;font-size:15px}

/* subcategory area */
.subcat-area{margin:12px 0 20px;padding:10px 6px;background:transparent}
.subcat-grid{display:flex;flex-wrap:wrap;gap:10px}
.subcat-card{background:#f6f8ff;padding:10px;border-radius:8px;cursor:pointer;border:1px solid #e8eefc;min-width:140px}
.subcat-card:hover{background:#eaf2ff}

/* skills grid */
.skills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-top:12px}
.skill-card{background:#fff;border-radius:10px;padding:10px;border:1px solid #eef3ff;position:relative;cursor:pointer;min-height:70px;display:flex;align-items:center;gap:8px}
.skill-card .icon{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
.skill-name{font-weight:600}
.pct-badge{position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.06);padding:4px 8px;border-radius:12px;display:flex;align-items:center;gap:6px;font-weight:700}
.pct-badge .pencil{cursor:pointer}

/* back button */
#step2Back{display:none;margin-bottom:12px;padding:8px 12px;border-radius:8px;border:none;background:#00337f;color:#fff;cursor:pointer}

/* responsive */
@media (max-width:900px){
  #fieldsSystem{flex-direction:column}
  #selectedPanel{position:relative;width:100%;height:auto}
}
</style>

<div id="fieldsSystem">
  <div id="selectedPanel" aria-label="Selected skills (step 2)">
    <h3>Selected Skills</h3>
    <div id="selectedCount" style="font-size:13px;color:#5b6b86;margin-bottom:8px">0 selected</div>
    <div class="selected-list" id="selectedList"></div>
  </div>

  <div id="fieldsMain">
    <h2 style="margin:0 0 12px">Explore Fields</h2>
    <div id="fieldsContainer" class="field-row"></div>

    <button id="step2Back">‚Üê Back</button>

    <div id="subcatContainer" class="subcat-area" style="display:none">
      <div id="subcatGrid" class="subcat-grid"></div>
    </div>

    <div id="skillsContainer" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3 id="skillsTitle" style="margin:0">Skills</h3>
      </div>
      <div id="skillsGrid" class="skills-grid"></div>
    </div>
  </div>
</div>

<script>
/* ===== STEP-2: Data (fields -> subcats -> skills) - separate state ===== */
const STEP2_DATA = {
  "Computer Science": {
    icon: "üíª",
    color: "#2d6cdf",
    subs: {
      "Programming": { icon: "üßë‚Äçüíª", skills: ["HTML","CSS","JavaScript","Python","C++","Java","SQL","MongoDB","Node.js","React"] },
      "Graphic Designing": { icon: "üé®", skills: ["Photoshop","Illustrator","Figma","CorelDRAW"] },
      "Hacking": { icon: "üõ°Ô∏è", skills: ["Ethical Hacking","PenTesting","Reverse Engineering"] },
      "Video Editing": { icon: "üé¨", skills: ["Premiere Pro","After Effects","Final Cut Pro"] },
      "MS Office": { icon: "üìÑ", skills: ["Word","Excel","PowerPoint"] }
    }
  },
  "Engineering": {
    icon: "üõ†Ô∏è", color:"#b06b2d",
    subs: {
      "Mechanical": { icon:"‚öôÔ∏è", skills:["AutoCAD","SolidWorks","Thermodynamics"] },
      "Civil": { icon:"üèóÔ∏è", skills:["Surveying","Revit","Concrete Tech"] },
      "Electrical": { icon:"üîå", skills:["Circuit Design","MATLAB","Power Systems"] }
    }
  },
  "Medical": {
    icon:"üè•", color:"#c62828",
    subs: { "General": { icon:"ü©∫", skills:["Anatomy","Surgery Basics","Pharmacology"] }, "Nursing": { icon:"üë©‚Äç‚öïÔ∏è", skills:["Patient Care","ICU Skills","Pathology"] } }
  },
  "Arts": {
    icon:"üé®", color:"#8e44ad",
    subs: { "Painting": { icon:"üñåÔ∏è", skills:["Oil Painting","Watercolors","Sketching"] }, "Music": { icon:"üéµ", skills:["Guitar","Piano","Singing"] } }
  },
  "Commerce": {
    icon:"üíº", color:"#0b6b4f",
    subs: { "Accounting": { icon:"üßæ", skills:["Bookkeeping","Auditing","Taxation"] }, "Finance": { icon:"üìà", skills:["Investment","Banking","Stock Market"] } }
  },
  "Social Media": {
    icon:"üì±", color:"#ff6b00",
    subs: { "Marketing": { icon:"üì£", skills:["Content Creation","SEO","Facebook Ads","TikTok Growth"] }, "Management": { icon:"üß≠", skills:["Community Management","Analytics","Branding"] } }
  },
  "Law": {
    icon:"‚öñÔ∏è", color:"#555555",
    subs: { "Criminal Law": { icon:"üïµÔ∏è", skills:["Case Analysis","Forensics","Advocacy"] }, "Corporate Law": { icon:"üìú", skills:["Contracts","Mergers","Compliance"] } }
  }
};

/* small icon map for individual skills (fallback to initials) */
const SKILL_ICONS = {
  "HTML":"<>","CSS":"#", "JavaScript":"JS", "Python":"Py","C++":"C++","Java":"‚òï","SQL":"DB","MongoDB":"MDB",
  "Node.js":"N","React":"‚öõ","Photoshop":"Ps","Illustrator":"Ai","Figma":"F","Premiere Pro":"Pr", "Excel":"XL",
  "Word":"Wd","PowerPoint":"Pp","AutoCAD":"AC","SolidWorks":"Sw","MATLAB":"M", "Anatomy":"An","Guitar":"üé∏",
  "Investment":"üíπ","Content Creation":"‚úçÔ∏è", "Ethical Hacking":"üõ°Ô∏è","PenTesting":"üß™"
};

/* state */
let step2State = { openField: null, openSubcat: null };
let selectedStep2 = []; // {name, percent, icon}

/* DOM refs */
const fieldsContainer = document.getElementById('fieldsContainer');
const subcatContainer = document.getElementById('subcatContainer');
const subcatGrid = document.getElementById('subcatGrid');
const skillsContainer = document.getElementById('skillsContainer');
const skillsGrid = document.getElementById('skillsGrid');
const skillsTitle = document.getElementById('skillsTitle');
const step2Back = document.getElementById('step2Back');
const selectedList = document.getElementById('selectedList');
const selectedCount = document.getElementById('selectedCount');

/* render fields row */
function renderFieldsRow(){
  fieldsContainer.innerHTML = "";
  for(const fieldName in STEP2_DATA){
    const fd = STEP2_DATA[fieldName];
    const card = document.createElement('div');
    card.className = 'field-card';
    card.innerHTML = `<div class="icon" style="background:${fd.color || '#333'}">${fd.icon}</div>
                      <div><div class="field-title">${fieldName}</div><div style="font-size:12px;color:#6b7a90">${Object.keys(fd.subs).length} categories</div></div>`;
    card.addEventListener('click', ()=> toggleField(fieldName, card));
    fieldsContainer.appendChild(card);
  }
}

/* toggle field open (accordion behavior) */
function toggleField(fieldName, cardElement){
  // close previous
  if(step2State.openField && step2State.openField !== fieldName){
    // collapse previous
    step2State.openField = null;
    step2State.openSubcat = null;
    subcatContainer.style.display = 'none';
    skillsContainer.style.display = 'none';
    step2Back.style.display = 'none';
    // remove active classes
    document.querySelectorAll('.field-card').forEach(c=>c.classList.remove('active'));
  }
  // if same clicked, toggle off
  const isOpening = step2State.openField !== fieldName;
  if(!isOpening){
    step2State.openField = null;
    subcatContainer.style.display = 'none';
    skillsContainer.style.display = 'none';
    step2Back.style.display = 'none';
    cardElement.classList.remove('active');
    return;
  }
  // open new
  step2State.openField = fieldName;
  step2State.openSubcat = null;
  // mark active card
  document.querySelectorAll('.field-card').forEach(c=>c.classList.remove('active'));
  cardElement.classList.add('active');

  // populate subcats
  renderSubcats(fieldName);
}

/* render subcategories for a field */
function renderSubcats(fieldName){
  subcatGrid.innerHTML = "";
  const subs = STEP2_DATA[fieldName].subs;
  for(const subName in subs){
    const info = subs[subName];
    const sc = document.createElement('div');
    sc.className = 'subcat-card';
    sc.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${info.icon} ${subName}</div><div style="font-size:12px;color:#6b7a90">${info.skills.length} skills</div>`;
    sc.addEventListener('click', ()=> openSubcat(fieldName, subName));
    subcatGrid.appendChild(sc);
  }
  subcatContainer.style.display = 'block';
  skillsContainer.style.display = 'none';
  step2Back.style.display = 'inline-block';
}

/* open a subcategory -> show skills */
function openSubcat(fieldName, subName){
  step2State.openSubcat = subName;
  const info = STEP2_DATA[fieldName].subs[subName];
  skillsTitle.textContent = `${subName} ‚Äî ${fieldName}`;
  skillsGrid.innerHTML = "";
  info.skills.forEach(skill=>{
    const card = document.createElement('div');
    card.className = 'skill-card';
    const icon = SKILL_ICONS[skill] || skill.slice(0,2).toUpperCase();
    card.innerHTML = `<div class="icon" style="background:#2b6cff">${icon}</div>
                      <div class="skill-name">${skill}</div>
                      <div class="pct-badge"><span class="pct-text">100%</span><span class="pencil" title="Edit">‚úé</span></div>`;
    // select skill on click (avoid when clicking pencil)
    card.addEventListener('click', (e)=>{
      if(e.target.classList.contains('pencil')) return;
      addSelectedSkill(skill, card.querySelector('.pct-text').textContent || "100%");
    });
    // pencil in skill card
    const pencil = card.querySelector('.pencil');
    pencil.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      openPercentEditorInCard(card);
    });
    skillsGrid.appendChild(card);
  });

  subcatContainer.style.display = 'none';
  skillsContainer.style.display = 'block';
  step2Back.style.display = 'inline-block';
}

/* back button behavior */
step2Back.addEventListener('click', ()=>{
  if(step2State.openSubcat){
    // close skills -> show subcats
    renderSubcats(step2State.openField);
    step2State.openSubcat = null;
  } else if(step2State.openField){
    // close subcats -> just fields
    step2State.openField = null;
    step2State.openSubcat = null;
    subcatContainer.style.display = 'none';
    skillsContainer.style.display = 'none';
    step2Back.style.display = 'none';
    document.querySelectorAll('.field-card').forEach(c=>c.classList.remove('active'));
  }
});

/* add to selected (left panel) */
function addSelectedSkill(name, pct="100%"){
  if(!selectedStep2.find(s=>s.name===name)){
    const icon = SKILL_ICONS[name] || name.slice(0,2).toUpperCase();
    selectedStep2.push({ name, percent: pct, icon });
    renderSelectedList();
  } else {
    // update percent if already exists? keep as is
  }
}

/* render left selected list */
function renderSelectedList(){
  selectedList.innerHTML = "";
  selectedCount.textContent = `${selectedStep2.length} selected`;
  selectedStep2.forEach((s, idx)=>{
    const div = document.createElement('div');
    div.className = 'sel-item';
    div.innerHTML = `<div class="icon" style="background:#00337f">${s.icon}</div>
                     <div class="name">${s.name}</div>
                     <div class="pct">${s.percent}</div>
                     <div class="edit" title="Edit percent" style="cursor:pointer">‚úé</div>
                     <div class="remove" title="Remove">√ó</div>`;
    // edit percent
    div.querySelector('.edit').addEventListener('click', ()=>{
      const newVal = prompt('Enter percent (0-100):', s.percent.replace('%','')) ;
      if(newVal !== null){
        let v = parseInt(newVal,10);
        if(isNaN(v) || v<0) v=0; if(v>100) v=100;
        s.percent = v + '%';
        // reflect in skills grid badges if visible
        updateAllBadges(s.name, s.percent);
        renderSelectedList();
      }
    });
    // remove
    div.querySelector('.remove').addEventListener('click', ()=>{
      selectedStep2 = selectedStep2.filter(x=>x.name !== s.name);
      renderSelectedList();
    });
    selectedList.appendChild(div);
  });
}

/* update badges in skills grid when percent changed */
function updateAllBadges(skillName, newPct){
  // skillsGrid cards
  skillsGrid.querySelectorAll('.skill-card').forEach(card=>{
    const nm = card.querySelector('.skill-name').textContent;
    if(nm === skillName){
      const badge = card.querySelector('.pct-text');
      if(badge) badge.textContent = newPct;
    }
  });
  // badge in any subcat clones not present (we rebuild on open)
}

/* inline percent editor for skill cards */
function openPercentEditorInCard(card){
  const badge = card.querySelector('.pct-badge');
  const current = badge.querySelector('.pct-text').textContent.replace('%','') || '100';
  badge.innerHTML = `<input class="pct-input" type="number" min="0" max="100" value="${parseInt(current,10)||100}" style="width:64px;padding:4px;border-radius:6px">`;
  const inp = badge.querySelector('.pct-input');
  inp.focus(); inp.select();
  function commit(){
    let v = parseInt(inp.value,10); if(isNaN(v) || v<0) v=0; if(v>100) v=100;
    badge.innerHTML = `<span class="pct-text">${v}%</span><span class="pencil" title="Edit">‚úé</span>`;
    // rebind pencil
    badge.querySelector('.pencil').addEventListener('click', (e)=>{ e.stopPropagation(); openPercentEditorInCard(card); });
    // if selected left panel contains it, update there
    const name = card.querySelector('.skill-name').textContent;
    const obj = selectedStep2.find(x=>x.name === name);
    if(obj) { obj.percent = v + '%'; renderSelectedList(); }
  }
  inp.addEventListener('blur', commit);
  inp.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ commit(); }
    if(e.key === 'Escape'){ badge.innerHTML = `<span class="pct-text">${current}%</span><span class="pencil" title="Edit">‚úé</span>`; badge.querySelector('.pencil').addEventListener('click', (ev)=>{ ev.stopPropagation(); openPercentEditorInCard(card); }); }
  });
}

/* init render */
renderFieldsRow();
renderSelectedList();

</script>

<script>
/* ----- data & existing save logic (unchanged) ----- */
const skillsList = ["HTML","CSS","JavaScript","Python","Node.js","React","SQL","Java","C++"];
let selectedSkills = JSON.parse(localStorage.getItem("selectedSkills")) || [];

/* existing DOM refs */
const input = document.getElementById("searchInput");
const panel = document.getElementById("panel");
const cardsWrap = document.getElementById("cards");
const selectedContainer = document.getElementById("selectedContainer");

/* render selected skills (kept same behavior) */
function renderSkills() {
  selectedContainer.innerHTML = "";
  selectedSkills.forEach(skillObj => {
    const skill = skillObj.name;
    const percent = skillObj.percent || "100%";
    const tag = document.createElement("div");
    tag.className = "skill-tag";
    tag.innerHTML = `
      <span>${skill}</span>
      <input type="text" value="${percent}" maxlength="4" />
      <span class="remove-btn">√ó</span>
    `;
    // update percent
    tag.querySelector("input").addEventListener("input", e => {
      skillObj.percent = e.target.value;
    });
    // remove
    tag.querySelector(".remove-btn").addEventListener("click", () => {
      selectedSkills = selectedSkills.filter(s => s.name !== skill);
      renderSkills();
    });
    selectedContainer.appendChild(tag);
  });
}
renderSkills();

/* Save to storage + redirect (unchanged) */
function saveSkills() {
  localStorage.setItem("selectedSkills", JSON.stringify(selectedSkills));
  alert("Skills saved! You can now submit personal data.");
  window.location.href = "personal.html";
}
document.getElementById("submitBtn").addEventListener("click", saveSkills);


/* ----- UI enhancements (new) ----- */

/* mapping for icon text + color class */
const ICON_MAP = {
  "HTML": { txt:"<>", cls:"ic-html" },
  "CSS": { txt:"#", cls:"ic-css" },
  "JavaScript": { txt:"JS", cls:"ic-js" },
  "Python": { txt:"Py", cls:"ic-py" },
  "Node.js": { txt:"N", cls:"ic-node" },
  "React": { txt:"‚öõ", cls:"ic-react" },
  "SQL": { txt:"DB", cls:"ic-sql" },
  "Java": { txt:"‚òï", cls:"ic-java" },
  "C++": { txt:"C++", cls:"ic-cpp" }
};

/* state for keyboard nav */
let visibleCards = []; // elements currently visible
let highlightIndex = -1;

/* helper: select skill by name (keeps input active) */
function selectSkillByName(name, pctText = "100%"){
  if(!selectedSkills.find(s => s.name === name)){
    selectedSkills.push({ name: name, percent: pctText });
    renderSkills();
  }
  // keep the input ready for the next search
  input.value = "";
  // small timeout to ensure focus after other event handling
  setTimeout(()=>{ 
    input.focus(); 
    // repopulate with full list so user can continue adding
    populateCards("");
  }, 0);
}

/* build full cards once (keeps DOM nodes ready) */
const cardNodes = {};
skillsList.forEach(name => {
  const div = document.createElement("div");
  div.className = "card";
  div.dataset.skill = name;
  div.innerHTML = `
    <div class="icon ${ICON_MAP[name]?.cls || ''}">${ICON_MAP[name]?.txt || name[0]}</div>
    <div class="meta">
      <div class="skill-name">${name}</div>
      <div class="small">Click to select</div>
    </div>
    <div class="percent-badge"><span class="pct-text">100%</span> <span class="pencil" title="Edit percent">‚úé</span></div>
  `;
  // pencil opens inline editor (works on the template node as well)
  const pencil = div.querySelector('.pencil');
  pencil.addEventListener('click', (ev) => {
    ev.stopPropagation();
    openPercentEditor(div);
  });
  cardNodes[name] = div;
});

/* percent editor */
function openPercentEditor(card){
  const badge = card.querySelector('.percent-badge');
  const current = (badge.querySelector('.pct-text') ? badge.querySelector('.pct-text').textContent.replace('%','') : '100') || '100';
  badge.innerHTML = `<input class="percent-edit" type="number" min="0" max="100" value="${parseInt(current,10)||100}">`;
  const inputNum = badge.querySelector('.percent-edit');
  inputNum.focus();
  inputNum.select();
  // commit on blur or enter
  function commit(){
    let v = parseInt(inputNum.value,10);
    if(isNaN(v) || v < 0) v = 0;
    if(v > 100) v = 100;
    badge.innerHTML = `<span class="pct-text">${v}%</span> <span class="pencil" title="Edit percent">‚úé</span>`;
    // rebind pencil handler for this badge
    badge.querySelector('.pencil').addEventListener('click', e=>{
      e.stopPropagation();
      openPercentEditor(card);
    });
    // if this skill already selected, update its percent
    const skillName = card.dataset.skill;
    const obj = selectedSkills.find(s=>s.name===skillName);
    if(obj) { obj.percent = v + "%"; renderSkills(); }
    // refresh visible cards so badges reflect new percent
    populateCards(input.value || "");
  }
  inputNum.addEventListener('blur', commit);
  inputNum.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ inputNum.blur(); e.preventDefault(); }
    if(e.key === 'Escape'){
      badge.innerHTML = `<span class="pct-text">${current}%</span> <span class="pencil" title="Edit percent">‚úé</span>`;
      badge.querySelector('.pencil').addEventListener('click', ev=>{ ev.stopPropagation(); openPercentEditor(card); });
    }
  });
}

/* open / close panel helpers */
function openPanel(){
  panel.style.display = "block";
  panel.setAttribute('aria-hidden','false');
  populateCards(input.value || "");
  highlightIndex = -1;
}
function closePanel(){
  panel.style.display = "none";
  panel.setAttribute('aria-hidden','true');
  visibleCards = []; highlightIndex = -1;
}

/* populate cards based on filter */
function populateCards(filter){
  cardsWrap.innerHTML = "";
  const q = (filter || "").trim().toLowerCase();
  visibleCards = [];
  skillsList.forEach(name => {
    if(!q || name.toLowerCase().includes(q)){
      const node = cardNodes[name].cloneNode(true);
      // ensure percent badge shows current percent (if selected) or default 100%
      const sel = selectedSkills.find(s=>s.name===name);
      const pct = sel ? (sel.percent || "100%") : "100%";
      const badge = node.querySelector('.percent-badge');
      badge.innerHTML = `<span class="pct-text">${pct}</span> <span class="pencil" title="Edit percent">‚úé</span>`;

      // rebind events after clone
      node.addEventListener("click", e=>{
        if(e.target.classList.contains('pencil')) return;
        const skill = node.dataset.skill;
        const pctText = node.querySelector('.pct-text').textContent || "100%";
        selectSkillByName(skill, pctText);
      });

      const pencil = node.querySelector('.pencil');
      pencil.addEventListener('click', ev=>{
        ev.stopPropagation();
        openPercentEditor(node);
      });

      // mouse hover should set highlight (no global reset)
      node.addEventListener('mouseenter', ()=> {
        highlightIndex = visibleCards.indexOf(node);
        updateHighlight();
      });

      cardsWrap.appendChild(node);
      visibleCards.push(node);
    }
  });
  // default first visible as highlighted (optional)
  if(visibleCards.length > 0) highlightIndex = 0;
  else highlightIndex = -1;
  updateHighlight();
}

/* highlight helpers */
function updateHighlight(){
  visibleCards.forEach((n,i)=>{
    n.classList.toggle('highlight', i === highlightIndex);
    if(i === highlightIndex) n.scrollIntoView({block:'nearest',behavior:'smooth'});
  });
}

/* keyboard nav (Up/Down/Left/Right wrap, Enter selects, Escape closes) */
input.addEventListener('keydown', (e)=>{
  // ignore when percent editor is focused
  const active = document.activeElement;
  if(active && active.classList && active.classList.contains('percent-edit')) return;

  if(panel.style.display === 'block'){
    if(e.key === 'ArrowDown' || e.key === 'ArrowRight'){
      e.preventDefault();
      if(visibleCards.length === 0) return;
      highlightIndex = (highlightIndex + 1) % visibleCards.length;
      updateHighlight();
    } else if(e.key === 'ArrowUp' || e.key === 'ArrowLeft'){
      e.preventDefault();
      if(visibleCards.length === 0) return;
      highlightIndex = (highlightIndex - 1 + visibleCards.length) % visibleCards.length;
      updateHighlight();
    } else if(e.key === 'Enter'){
      e.preventDefault();
      if(highlightIndex >= 0 && visibleCards[highlightIndex]){
        // select highlighted directly to avoid focus side-effects of click
        const node = visibleCards[highlightIndex];
        const skill = node.dataset.skill;
        const pctText = node.querySelector('.pct-text').textContent || "100%";
        selectSkillByName(skill, pctText);
        // keep highlight at start for next entry
        highlightIndex = 0;
        updateHighlight();
      } else if(visibleCards.length === 1){
        const node = visibleCards[0];
        const skill = node.dataset.skill;
        const pctText = node.querySelector('.pct-text').textContent || "100%";
        selectSkillByName(skill, pctText);
      }
    } else if(e.key === 'Escape'){
      e.preventDefault();
      closePanel();
      input.blur();
    }
  }
});

/* typing & auto-type effect (before user interacts) */
let autoTyping = true;
let autoTimer = null;
let typeIndex = 0;
let charIndex = 0;
let forward = true;
function startAutoType(){
  if(autoTimer) clearInterval(autoTimer);
  autoTyping = true;
  input.placeholder = '';
  charIndex = 0; forward = true;
  autoTimer = setInterval(()=>{
    const word = skillsList[typeIndex % skillsList.length];
    if(forward){
      charIndex++;
      input.value = word.slice(0, charIndex);
      if(charIndex >= word.length){ forward = false; setTimeout(()=>{}, 200); }
    } else {
      charIndex--;
      input.value = word.slice(0, charIndex);
      if(charIndex <= 0){ forward = true; typeIndex++; }
    }
  }, 120);
}
function stopAutoTypeInstant(){
  if(autoTimer) clearInterval(autoTimer);
  autoTyping = false;
  // clear fast in 0.1s and set placeholder
  setTimeout(()=>{ input.value = ""; input.placeholder = "Search any skill"; }, 100);
}

/* input focus behavior */
input.addEventListener('focus', (e)=>{
  stopAutoTypeInstant();
  openPanel();
});
input.addEventListener('click', (e)=>{
  if(autoTyping) stopAutoTypeInstant();
  openPanel();
});
input.addEventListener('input', (e)=>{
  const q = e.target.value;
  populateCards(q);
});

/* click outside to close */
document.addEventListener('click', (e)=>{
  if(!document.querySelector('.search-wrap').contains(e.target)) closePanel();
});

/* start auto-typing on load */
startAutoType();

</script>
</body>
</html>
