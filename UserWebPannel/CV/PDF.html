<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Final Professional CV ‚Äî Preview & PDF</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f6f8;
  --card:#ffffff;
  --panel:#243142;
  --content:#1f2937;
  --sub:#6b7280;
  --accent:#0b72c3;
  --muted:#9aa0a6;
  --pdf-width-mm:210mm;
  --pdf-height-mm:297mm;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);font-family:'Poppins',system-ui,Arial;color:var(--content)}
a{color:var(--accent);text-decoration:none}
.container{display:flex;justify-content:center;padding:18px}
.cv-sheet{width:794px;height:1123px;background:var(--card);border-radius:6px;box-shadow:0 12px 30px rgba(16,24,32,0.08);display:flex;overflow:hidden;padding:18px;color:var(--content)}
.sidebar{width:250px;background:linear-gradient(180deg,var(--panel),#16222a);color:#fff;padding:18px;display:flex;flex-direction:column;gap:12px;overflow:hidden}
.profile-img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,255,255,0.12);margin:0 auto 6px auto;display:block}
.sidebar .name-small{text-align:center;font-weight:700;font-size:14px;color:#fff;margin-bottom:2px}
.sidebar .role-small{text-align:center;font-size:12px;color:rgba(255,255,255,0.85);margin-bottom:8px}
.section-title{display:flex;gap:8px;align-items:center;font-weight:700;text-transform:uppercase;font-size:11px;color:rgba(255,255,255,0.9)}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.chip{background:#fff;color:var(--panel);padding:6px 8px;border-radius:999px;font-size:11px;display:inline-flex;align-items:center;gap:6px}
.skill-list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.skill-row{display:flex;flex-direction:column;gap:4px}
.skill-meta{display:flex;justify-content:space-between;font-weight:600;font-size:11px}
.skill-bar-wrap{height:8px;background:rgba(255,255,255,0.12);border-radius:999px;overflow:hidden}
.skill-bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#1e8fe1);border-radius:999px;transition:width .6s ease}
.personal-list{display:flex;flex-direction:column;gap:6px;font-size:11px}
.personal-item{display:flex;gap:8px;align-items:center;color:rgba(255,255,255,0.95)}
.main{flex:1;padding-left:18px;display:flex;flex-direction:column;overflow:hidden}
.header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:-16px}
.name-large{font-size:28px;font-weight:800;color:var(--content)}
.profession{font-size:18px;color:var(--accent);font-weight:600;margin-top:1px}
h5{font-size:12px;color:var(--content);font-weight:600;margin-top:1px}
.about{font-size:11px;color:var(--sub);margin-top:2px;max-width:100%}
.section{margin-top:10px;display:flex;flex-direction:column;gap:6px}

.section .title{display:flex;align-items:center;gap:8px;font-weight:700;font-size:12px;color:var(--content);border-bottom:1px solid #e7eaec;padding-bottom:6px}
.section .title .icon{width:28px;height:28px;border-radius:6px;background:rgba(11,114,195,0.08);display:inline-grid;place-items:center;color:var(--accent)}
.section .list{display:flex;flex-direction:column;gap:6px;margin-top:6px}
.item{padding:8px;border-radius:6px;background:transparent;display:flex;flex-direction:column;gap:2px;font-size:10.8px;color:var(--content)}
.item .line{font-size:10.8px;color:var(--content);line-height:1.1}
.item .sub{font-size:10px;color:var(--sub)}
.col-row{display:flex;gap:10px}
.col-box{flex:1;background:#f7f8fa;border-radius:8px;padding:8px;font-size:10.5px;color:var(--content)}
@media (max-width:900px){
  .cv-sheet{width:100%;height:auto;flex-direction:column}
  .sidebar{width:100%;flex-direction:row;gap:12px;padding:12px;align-items:center}
  .main{padding-left:12px}
}
@media print{
  body{background:#fff}
  .container{padding:0}
  .cv-sheet{box-shadow:none;border-radius:0}
}
#modalViewer {
    display: block;                  /* Make visible when needed */
    overflow-y: auto;                /* Enable vertical scroll */
    max-height: 80vh;                /* Fit modal vertically */
    padding: 8px;
    background:#f9f9f9;
    border-radius:6px;
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
}


</style>
</head>
<body>
<div class="container">
  <div id="cv" class="cv-sheet" role="document" aria-label="CV">
    <aside class="sidebar" id="sidebar">
      <img id="profileImage" class="profile-img" alt="Profile">
      <div class="name-small" id="sidebarName"></div>
      <div class="role-small" id="sidebarRole"></div>

       <div class="section-title" style="margin-top:6px"><span class="icon">üë§</span><div>Personal Info</div></div>
      <div class="personal-list" id="personalList"></div>

      <div id="langWrap">
        <div class="section-title"><span class="icon">üè∑Ô∏è</span><div>Languages</div></div>
        <div class="chips" id="langList"></div>
      </div>
         <div id="skillsWrap">
        <div class="section-title"><span class="icon">üõ†Ô∏è</span><div>Skills</div></div>
        <div class="skill-list" id="skillList"></div>
      </div>

      <div id="hobbyWrap">
        <div class="section-title"><span class="icon">üéØ</span><div>Hobbies</div></div>
        <div class="chips" id="hobbyList"></div>
      </div>

  
    </aside>

    <main class="main" id="mainCV">
      <header class="header">
        <div>
          <div class="name-large" id="fullName"></div>
          <div class="profession" id="Resumeprofession"></div>
          <h5>About Me
          <div class="about" id="Aboutpera"></div></h5>
        </div>
      </header>

      <section class="section" id="educationSection">
        <div class="title"><div class="icon">üéì</div><div>Education</div></div>
        <div class="list" id="educationList"></div>
      </section>

      <section class="section" id="experienceSection">
        <div class="title"><div class="icon">üè¢</div><div>Experience</div></div>
        <div class="list" id="experienceList"></div>
      </section>

      <section class="section" id="projectsSection">
        <div class="title"><div class="icon">üí°</div><div>Projects</div></div>
        <div class="col-row" id="projectsRow"></div>
      </section>

      <section class="section" id="referencesSection">
        <div class="title"><div class="icon">üìò</div><div>References</div></div>
        <div class="col-row" id="referencesRow"></div>
      </section>
    </main>
  </div>
</div>

<div style="text-align:center;margin:12px">
  <button id="displayDownloadBtn" class="btn ghost">Display & Download</button>
</div>

<div id="overlay" style="display:none;position:fixed;inset:0;z-index:1200">
  <div style="position:absolute;inset:0;background:rgba(0,0,0,0.6)"></div>
  <div style="position:relative;max-width:980px;margin:8% auto;background:#fff;padding:12px;border-radius:10px;z-index:1210">
    <div style="display:flex;gap:10px">
      <button id="displayBtn">Display</button>
      <button id="downloadBtn">Download</button>
      <button id="closeModal">Close</button>
    </div>
    <div id="modalViewer" style="margin-top:10px;display:none"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script type="module">// ResumeFinal.js
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, child, get } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCmL8qcjg4S6NeY3erraq_XhlDJ7Ek2s_E",
  authDomain: "palestine-web.firebaseapp.com",
  databaseURL: "https://palestine-web-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "palestine-web",
  storageBucket: "palestine-web.appspot.com",
  messagingSenderId: "35190212487",
  appId: "1:35190212487:web:0a699bb1fa7b1a49113522",
  measurementId: "G-8TE04Z9ZFW"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

// Elements
const cvSheet = document.getElementById('cv');
const profileImage = document.getElementById('profileImage');
const sidebarName = document.getElementById('sidebarName');
const sidebarRole = document.getElementById('sidebarRole');
const skillListEl = document.getElementById('skillList');
const langListEl = document.getElementById('langList');
const hobbyListEl = document.getElementById('hobbyList');
const personalListEl = document.getElementById('personalList');
const fullNameEl = document.getElementById('fullName');
const resumeprofessionEl = document.getElementById('Resumeprofession');
const aboutpera = document.getElementById('Aboutpera');
const educationList = document.getElementById('educationList');
const experienceList = document.getElementById('experienceList');
const projectsRow = document.getElementById('projectsRow');
const referencesRow = document.getElementById('referencesRow');
const overlay = document.getElementById('overlay');
const modalViewer = document.getElementById('modalViewer');
const displayDownloadBtn = document.getElementById('displayDownloadBtn');
const displayBtn = document.getElementById('displayBtn');
const downloadBtn = document.getElementById('downloadBtn');
const closeModal = document.getElementById('closeModal');

// Limits
const LIMITS = { education:4, experience:4, skills:10, languages:10, hobbies:10, projects:3, references:2 };

// CNIC
let CNIC = localStorage.getItem('Cnic') || prompt('Enter CNIC:');
if(!CNIC) CNIC='unknown';
localStorage.setItem('Cnic', CNIC);

// Helpers
function safeText(v){ return (v===undefined||v===null||v==='')? '' : String(v).trim(); }
function mapHobbyIcon(h){ const k=(h||'').toLowerCase(); if(k.includes('travel'))return '‚úàÔ∏è';if(k.includes('photo'))return 'üì∏';if(k.includes('music'))return 'üéß';if(k.includes('game'))return 'üéÆ';if(k.includes('read'))return 'üìö';if(k.includes('fit'))return 'üèãÔ∏è'; return '‚≠ê'; }

// Fetch user data
async function fetchUser(){ 
  const dbRef = ref(db); 
  const snap = await get(child(dbRef, `resContainer9/${CNIC}`)); 
  return snap.exists()? snap.val() : {}; 
}

// Render CV
function render(data){
  const personal = data.Personal || {};
  const imageUrl = safeText(personal.ImageUrl) || '/assets/default-profile.png';
  profileImage.src = imageUrl;
  fullNameEl.textContent = safeText(personal.Name)||'';
  resumeprofessionEl.textContent = safeText(personal.Resumeprofession)||'';
  aboutpera.textContent = safeText(personal.Aboutpera)||'';

  personalListEl.innerHTML = '';
  [['Father',personal.Fname],['CNIC',personal.Cnic],['Phone',personal.Phone],['Bsnumber',personal.Bsnumber],['Email',personal.Email],['Address',personal.Caddres]].forEach(([l,v])=>{
    if(safeText(v)) personalListEl.insertAdjacentHTML('beforeend',`<div class="personal-item"><strong style="min-width:70px">${l}:</strong><span>${safeText(v)}</span></div>`);
  });

  skillListEl.innerHTML=''; 
  Object.values(data.Skills||{}).slice(0,LIMITS.skills).forEach(s=>{
    const name=s.name||s;
    const pct=s.level||s.percent||'0%';
    skillListEl.insertAdjacentHTML('beforeend',`<div class="skill-row"><div class="skill-meta"><div>${name}</div><div>${pct}</div></div><div class="skill-bar-wrap"><div class="skill-bar" style="width:${pct}"></div></div></div>`);
  });

  langListEl.innerHTML=''; 
  (safeText(personal.Paddres)||'').split(',').map(x=>x.trim()).filter(Boolean).slice(0,LIMITS.languages).forEach(l=>langListEl.insertAdjacentHTML('beforeend',`<div class="chip">${l}</div>`));

  hobbyListEl.innerHTML=''; 
  (safeText(personal.Qual)||'').split(',').map(x=>x.trim()).filter(Boolean).slice(0,LIMITS.hobbies).forEach(h=>hobbyListEl.insertAdjacentHTML('beforeend',`<div class="chip">${mapHobbyIcon(h)} ${h}</div>`));

  educationList.innerHTML=''; 
  Object.values(data.Education||{}).filter(e=>e && (e.Name||e.Degree)).slice(0,LIMITS.education).forEach(ed=>{
    const c=document.createElement('div'); c.className='item'; 
    if(ed.Startyear||ed.Endyear)c.insertAdjacentHTML('beforeend',`<div class="line">${ed.Startyear||''}${ed.Startyear||ed.Endyear?' - ':''}${ed.Endyear||''}</div>`);
    ['Name','Degree','Field','Subfield','Gpa'].forEach(f=>{if(ed[f]) c.insertAdjacentHTML('beforeend',`<div class="line">${f==='Gpa'?'GPA: '+ed[f]:ed[f]}</div>`)}); 
    educationList.appendChild(c);
  });

  experienceList.innerHTML=''; 
  (Array.isArray(data.Experience)?data.Experience:Object.values(data.Experience||{})).slice(0,LIMITS.experience).forEach(ex=>{
    const c=document.createElement('div');c.className='item';
    if(ex.durationNumber||ex.durationUnit)c.insertAdjacentHTML('beforeend',`<div class="line">${ex.durationNumber||''}${ex.durationNumber||ex.durationUnit?' - ':''}${ex.durationUnit||''}</div>`);
    ['organizationName','organizationPosition','Department','details'].forEach(f=>{if(ex[f]) c.insertAdjacentHTML('beforeend',`<div class="${f==='details'?'sub':'line'}">${ex[f]}</div>`)}); 
    experienceList.appendChild(c);
  });

  projectsRow.innerHTML=''; 
  (Array.isArray(data.Project)?data.Project:Object.values(data.Project||{})).slice(0,LIMITS.projects).forEach(p=>{
    const b=document.createElement('div'); b.className='col-box'; 
    b.innerHTML=`<div style="font-weight:700">${safeText(p.category)||''}</div><div>${safeText(p.projectName)||''}</div>${p.projectUrl?`<div style="margin-top:6px;font-size:10px"><a href="${p.projectUrl}" target="_blank">${p.projectUrl}</a></div>`:''}`; 
    projectsRow.appendChild(b);
  }); 
  while(projectsRow.children.length<2) projectsRow.appendChild(document.createElement('div')).lastChild.className='col-box',projectsRow.lastChild.style.visibility='hidden';

  referencesRow.innerHTML=''; 
  const refs=[]; 
  if(data.JobReference){if(data.JobReference.Reference1)refs.push(data.JobReference.Reference1); if(data.JobReference.Reference2)refs.push(data.JobReference.Reference2);} 
  refs.slice(0,LIMITS.references).forEach(r=>{
    const b=document.createElement('div');b.className='col-box'; 
    b.innerHTML=`<div style="font-weight:700">${safeText(r.Name)||''}</div><div class="sub">${safeText(r.Post)||''}</div><div style="margin-top:6px;font-size:11px">${safeText(r.PhoneNumber)||''}${r.Email?' ‚Ä¢ '+safeText(r.Email):''}</div>`; 
    referencesRow.appendChild(b);
  }); 
  while(referencesRow.children.length<2) referencesRow.appendChild(document.createElement('div')).lastChild.className='col-box',referencesRow.lastChild.style.visibility='hidden';

  requestAnimationFrame(()=>document.querySelectorAll('.skill-bar').forEach(b=>{const w=b.style.width;b.style.width='0%';setTimeout(()=>b.style.width=w,60)}));
}

// Wait for images
function waitForImages(container){
  const imgs = Array.from(container.querySelectorAll('img'));
  return Promise.all(imgs.map(img=>{
    if(img.complete) return Promise.resolve();
    return new Promise(resolve=>{img.onload=img.onerror=resolve});
  }));
}

// Create & download PDF with profile image
async function createAndDownloadPdf(){
  await waitForImages(cvSheet);
  const opt = {
    margin: 0,
    filename: `Resume-Cv.pdf`,
    image: { type: "jpeg", quality: 1 },
    html2canvas: { scale: 3, useCORS: true, scrollY: 0, windowHeight: cvSheet.scrollHeight },
    jsPDF: { unit: "px", format: [794, 1123], orientation: "portrait" }
  };
  const pdfBlob = await html2pdf().set(opt).from(cvSheet).outputPdf('blob');

  // Upload PDF to Firebase
  const storagePath = `ResumePdf/Portfolio/${CNIC}/Resume-Cv.pdf`;
  const fileRef = storageRef(storage, storagePath);
  await uploadBytes(fileRef, pdfBlob);

  // Auto download
  const url = URL.createObjectURL(pdfBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Resume-Cv.pdf';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// Display modal with clone CV
displayDownloadBtn.addEventListener('click',()=>overlay.style.display='block');
closeModal.addEventListener('click',()=>overlay.style.display='none');

displayBtn.addEventListener('click', async () => {
  modalViewer.innerHTML = "";
  const clone = cvSheet.cloneNode(true);
  clone.style.width="100%";
  clone.style.height="auto";
  clone.style.transform="scale(0.8)";
  clone.style.transformOrigin="top center";
  clone.style.margin="0 auto 20px auto";
  modalViewer.appendChild(clone);
  await waitForImages(clone);
  modalViewer.style.display='block';
  overlay.style.display='block';
});

// Download with paymentStatus check
downloadBtn.addEventListener('click', async()=>{
  try{
    const dbRef = ref(db);
    const snap = await get(child(dbRef, `resContainer9/${CNIC}/Access`));
    const status = snap.val()?.paymentStatus || 'pending';
    if(status !== 'Verified'){
      window.location.href='/personal-portfolio-html-template/Login/payment.html';
      return;
    }
    await createAndDownloadPdf();
  }catch(err){ console.error(err); alert('Error generating/downloading PDF'); }
});

// Load CV data
fetchUser().then(render).catch(err=>console.error(err));
</script>
</body>
</html>
